name: "Action to commit changes to the repository"
inputs:
  token:
    description: "GitHub token"
    required: true
outputs:
  sha:
    description: "SHA of generated commit"
    value: ${{ steps.commit.outputs.sha }}

runs:
  using: "composite"
  steps:
    - name: Commit to a new branch and create PR if changed
      id: commit
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      run: |
        set -x
        if [ -n "$(git status --porcelain)" ]; then
          echo "Changed"
          current_branch=$(git branch --show-current)
          new_branch=gha-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}-${GITHUB_RUN_ATTEMPT}
          git checkout -b ${new_branch}
          git add .
          git commit -m "chore: Auto-update from GitHub Actions"$'\n'$'\n'"Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          git push -u origin HEAD

          this_sha=$(git rev-parse HEAD)

          pr_number=$(gh pr create --base main --head ${new_branch} --title "chore: Auto-update from GitHub Actions" --body "Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" | sed '#^[.*]/([^/]+)#\1#')

          sha=$(gh api -X PUT /repos/$GITHUB_REPOSITORY/pulls/$pr_number/merge -f merge_method=merge -f sha=${this_sha} | jq -r '.sha')

          echo sha=$sha >> $GITHUB_OUTPUT
        fi
      shell: bash
